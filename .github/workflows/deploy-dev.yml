name: 2️⃣ Deploy to Dev (Auto)

on:
  workflow_run:
    workflows: ["1️⃣ Test and Build"]
    types:
      - completed
    branches:
      - main
      - develop
  workflow_dispatch: # Allow manual trigger

env:
  REGISTRY: ghcr.io
  NAMESPACE: dev

jobs:
  deploy:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: dev
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Set image repository (lowercase)
        id: image-repo
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner=${REPO_OWNER}" >> $GITHUB_OUTPUT

      - name: Get commit SHA from triggering workflow
        id: get-sha
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            SHA="${{ github.event.workflow_run.head_sha }}"
          else
            SHA="${{ github.sha }}"
          fi
          SHORT_SHA=$(echo ${SHA} | cut -c1-7)
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Using SHA: ${SHORT_SHA}"

      - name: Configure kubectl
        run: |
          echo "${{ secrets.DEV_KUBECONFIG }}" | base64 -d > /tmp/kubeconfig
          sed -i 's|server: https://127.0.0.1:6443|server: https://72.62.40.154:6443|g' /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig
          kubectl cluster-info

      - name: Configure image pull secrets for GHCR
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.CONTAINER_TOKEN }} \
            --namespace ${NAMESPACE} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy admin-backend
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          helm upgrade --install admin-backend charts/admin-backend \
            --namespace ${NAMESPACE} \
            --create-namespace \
            -f env-values/dev/global.yaml \
            -f env-values/dev/admin-backend.yaml \
            --set image.tag=sha-${{ steps.get-sha.outputs.short_sha }} \
            --set image.repository=${REGISTRY}/${{ steps.image-repo.outputs.repo_owner }}/admin-backend \
            --set imagePullSecrets[0].name=ghcr-secret \
            --wait --timeout=5m

      - name: Verify deployment
        run: |
          export KUBECONFIG=/tmp/kubeconfig
          echo "✅ Deployment Status:"
          kubectl get pods -n ${NAMESPACE} -l app=admin-backend
          kubectl get svc -n ${NAMESPACE} -l app=admin-backend
